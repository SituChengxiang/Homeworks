# 第五章 曲线拟合（Curve Fitting）

## 5.1 引言：插值 vs 拟合

| 方法 | 要求 | 适用场景 |
|------|------|--------|
| **插值**（第四章） | $P(x_i) = y_i$（严格过点） | 数据精确、无噪声 |
| **拟合**（本章） | 最小化整体误差（不过点） | 数据含测量误差、趋势建模 |

> **核心思想**：当数据存在误差时，强行过点会导致“噪声放大”（如龙格现象），应寻求**最佳逼近函数**。

---

## 5.2 最小二乘法（Least Squares）

### 1. 问题设定

给定 $N$ 个数据点 $(x_i, y_i),\ i=1,\dots,N$，寻找函数 $f(x)$ 使**误差平方和最小**：
$$
E = \sum_{i=1}^N \left( f(x_i) - y_i \right)^2 \to \min
$$

常用误差指标：

- **最大误差**：$\max |f(x_i) - y_i|$
- **平均误差**：$\frac{1}{N} \sum |f(x_i) - y_i|$
- **均方根误差（RMS）**：$\sqrt{\frac{1}{N} \sum (f(x_i) - y_i)^2}$

> **最小二乘** 使用 RMS 的平方，便于求导，计算稳定。

---

### 2. 线性模型：直线拟合 $y = Ax + B$

目标：最小化
$$
E(A,B) = \sum_{i=1}^N (A x_i + B - y_i)^2
$$

<details>
<summary>正规方程推导</summary>

对 $A$ 和 $B$ 求偏导并令其为零：

$$
\begin{aligned}
\frac{\partial E}{\partial A} &= 2 \sum (A x_i + B - y_i) x_i = 0 \\
\frac{\partial E}{\partial B} &= 2 \sum (A x_i + B - y_i) = 0
\end{aligned}
$$

整理得**正规方程（Normal Equations）**：
$$
\begin{cases}
A \sum x_i^2 + B \sum x_i = \sum x_i y_i \\
A \sum x_i + B N = \sum y_i
\end{cases}
$$
</details>

- 注意，后续的公式中如果存在交叉项，可以用多个下标标记。

#### 1. 一般的函数形式

$$
f(x) = c_1 f_1(x) + c_2 f_2(x) + \cdots + c_M f_M(x)
$$
这与我们整理中的 **“一般线性组合模型”** 完全一致：
> “设：$f(x) = c_1 f_1(x) + c_2 f_2(x) + \cdots + c_m f_m(x)$，其中 $f_1, \dots, f_m$ 为已知线性无关函数”

#### 2. 一般方程的误差平方和

$$
E(c_1, c_2, \dots, c_M) = \sum_{k=1}^N (f(x_k) - y_k)^2
$$
这正是我们定义的**最小二乘目标函数**：
> “目标：最小化误差平方和：$E = \sum_{i=1}^N (f(x_i) - y_i)^2$”

#### 3. 求偏导过程

$$
\frac{\partial E}{\partial c_i} = 0, \quad i=1,2,\dots,M
$$
这对应我们整理中的**正规方程推导**：
<details>
<summary>正规方程推导（来自整理）</summary>

对 $c_j$ 求偏导并令其为零：

$$
\begin{aligned}
\frac{\partial E}{\partial c_j} &= 2 \sum_{i=1}^N \left( \sum_{k=1}^{M+1} c_k f_k(x_i) - y_i \right) f_j(x_i) = 0 \\
&\Rightarrow \sum_{i=1}^N \sum_{k=1}^{M+1} c_k f_k(x_i) f_j(x_i) = \sum_{i=1}^N y_i f_j(x_i)
\end{aligned}
$$

</details>
（假指标收缩）

$$
\boxed{\sum_{j=1}^M \left( \sum_{k=1}^N f_i(x_k) f_j(x_k) \right) c_j = \sum_{k=1}^N f_i(x_k) y_k}
$$
这正是我们整理中用矩阵形式表达的**正规方程**：
> “正规方程为：$F^T F \mathbf{c} = F^T \mathbf{y}$”
> 其中 $F_{ij} = f_j(x_i)$，即设计矩阵。

这个 $M \times M$ 的方程组就是 $F^T F \mathbf{c} = F^T \mathbf{y}$ 的展开形式。

#### 例子：直线拟合

数据点：$(0,1.5), (1,2.5), (2,3.5), (3,5.0), (4,7.5)$

计算：

- $\sum x_i = 10$, $\sum y_i = 20$
- $\sum x_i^2 = 30$, $\sum x_i y_i = 55$

正规方程：
$$
\begin{cases}
30A + 10B = 55 \\
10A + 5B = 20
\end{cases}
\Rightarrow A = 1.5,\ B = 1.0
$$

→ 拟合直线：$y = 1.5x + 1.0$

> **MATLAB 实现**：
>
> ```matlab
> x = 0:4; y = [1.5,2.5,3.5,5.0,7.5];
> p = polyfit(x, y, 1);  % p = [1.5, 1.0]
> ```

---

### 3. 多项式拟合 $y = c_0 + c_1 x + \cdots + c_m x^m$

设基函数 $f_j(x) = x^{j-1},\ j=1,\dots,m+1$，则
$$
f(x) = \sum_{j=1}^{m+1} c_j f_j(x)
$$

误差：
$$
E = \sum_{i=1}^N \left( \sum_{j=1}^{m+1} c_j f_j(x_i) - y_i \right)^2
$$

<details>
<summary>矩阵形式与正规方程</summary>

令：

- **设计矩阵** $F \in \mathbb{R}^{N \times (m+1)}$，$F_{ij} = f_j(x_i) = x_i^{j-1}$
- **系数向量** $\mathbf{c} = [c_0, c_1, \dots, c_m]^T$
- **观测向量** $\mathbf{y} = [y_1, \dots, y_N]^T$

则正规方程为：
$$
F^T F \mathbf{c} = F^T \mathbf{y}
$$

解此线性方程组即可得最优系数。
</details>

#### 例子：多项式拟合 $f(x) = \frac{1}{1+x^2}$

在 $[-5,5]$ 上取 11 个等距点，分别用 5 次、10 次多项式拟合。

- **5 次拟合**：效果良好；
- **10 次拟合**：端点剧烈震荡（**龙格现象**）。

> **启示**：高次多项式拟合 ≠ 高精度！应优先使用**低次多项式**或**样条**。

---

## 5.3 非线性模型的线性化

许多非线性模型可通过变量替换转化为线性模型。

| 原模型 | 变换 | 新变量 |
|--------|------|--------|
| $y = C e^{Ax}$ | $\ln y = Ax + \ln C$ | $Y = \ln y,\ B = \ln C$ |
| $y = A x^M$（$M$ 已知） | $\ln y = \ln A + M \ln x$ | $Y = \ln y,\ X = \ln x$ |
| $y = \frac{1}{Ax + B}$ | $\frac{1}{y} = Ax + B$ | $Y = 1/y$ |

### 例子：指数拟合 $y = C e^{Ax}$

数据同上直线例子。

1. 变换（线性化）：$Y_i = \ln y_i$
2. 对 $(x_i, Y_i)$ 做直线拟合：$Y = Ax + B$
3. 得 $A = 0.32,\ B = 0.405$
4. $C = e^B \approx 1.5$

→ 拟合曲线：$y = 1.5 e^{0.32x}$

> [!IMPORTANT]
> **注意**：线性化会**改变误差结构**（原误差在 $y$，现为在 $\ln y$），若需精确拟合，应使用**非线性最小二乘**（如 `lsqcurvefit`）。

---

## 5.4 一般线性组合模型

设：
$$
f(x) = c_1 f_1(x) + c_2 f_2(x) + \cdots + c_m f_m(x)
$$
其中 $f_1, \dots, f_m$ 为已知线性无关函数（如 $1, e^{-3x}, \cos(2x)e^{-4x}, x^2$）。

则正规方程仍为：
$$
F^T F \mathbf{c} = F^T \mathbf{y}
$$
其中 $F_{ij} = f_j(x_i)$。

### 例子（来自 PDF）

数据：

```matlab
x = [0,0.2,...,1.5]';
y = [2.88,2.2576,...,3.2052]';
```

模型：
$$
f(x) = c_1 + c_2 e^{-3x} + c_3 \cos(2x) e^{-4x} + c_4 x^2
$$

构建 $F = [\mathbf{1},\ e^{-3x},\ \cos(2x)e^{-4x},\ x^2]$

解得：
$$
c_1 \approx 1.22,\ c_2 \approx 2.34,\ c_3 \approx -0.68,\ c_4 \approx 0.87
$$

> **MATLAB 实现**：
>
> ```matlab
> F = [ones(size(x)), exp(-3*x), cos(2*x).*exp(-4*x), x.^2];
> c = (F' * F) \ (F' * y);  % 或 c = F \ y;
> ```

---

## 5.5 样条函数插值（Spline Interpolation）

为避免高次多项式震荡，将区间分段，每段用低次多项式（通常 3 次）连接。

### 1. 三次样条定义

给定节点 $x_0 < x_1 < \cdots < x_N$，三次样条 $S(x)$ 满足：

1. 在每个子区间 $[x_k, x_{k+1}]$，$S(x)$ 是三次多项式；
2. $S(x_i) = y_i$（插值条件）；
3. $S, S', S''$ 在整个区间上连续；
4. **端点条件**（决定唯一性）：
   - **自然样条**：$S''(x_0) = S''(x_N) = 0$
   - **紧压样条**：给定 $S'(x_0)$ 和 $S'(x_N)$
   - **Not-a-knot**：在 $x_1$ 和 $x_{N-1}$ 处三阶导连续（MATLAB 默认）

<details>
<summary>样条构造简述</summary>

设 $m_k = S''(x_k)$，则在 $[x_k, x_{k+1}]$ 上：
$$
S(x) = \frac{m_k}{6h_k}(x_{k+1} - x)^3 + \frac{m_{k+1}}{6h_k}(x - x_k)^3 + \left( \frac{y_k}{h_k} - \frac{m_k h_k}{6} \right)(x_{k+1} - x) + \left( \frac{y_{k+1}}{h_k} - \frac{m_{k+1} h_k}{6} \right)(x - x_k)
$$
其中 $h_k = x_{k+1} - x_k$。

由 $S'(x)$ 连续可得 $N-1$ 个方程，加上端点条件，可解出 $m_0, \dots, m_N$。
</details>

#### 例子：紧压三次样条

节点：$(0,0), (1,0.5), (2,2.0), (3,1.5)$，给定 $S'(0) = 0.2,\ S'(3) = -1$。

解得样条段表达式（略），绘图光滑无震荡。

> **MATLAB 实现**：
>
> ```matlab
> x = [0,1,2,3]; y = [0,0.5,2.0,1.5];
> % 自然样条
> pp = csape(x, y, 'second');  % 'second' 表示自然样条（二阶导为0）
> % 紧压样条
> pp = csape(x, y, 'complete', [0.2, -1]);
> fnplt(pp); hold on; plot(x, y, 'o');
> ```

---

## 5.6 MATLAB 曲线拟合工具箱

| 任务 | 函数 | 说明 |
|------|------|------|
| 多项式拟合 | `p = polyfit(x, y, n)` | 返回降幂系数 |
| 多项式求值 | `y = polyval(p, x)` | |
| 三次样条插值 | `yy = spline(x, y, xx)` | 默认 not-a-knot |
| 通用样条 | `pp = csapi(x, y)` | ppform 格式 |
| 指定端点样条 | `pp = csape(x, y, conds)` | 'natural', 'complete' 等 |
| 非线性拟合 | `lsqcurvefit`, `fit` | 需提供模型函数 |

---

## 总结：方法选择建议

| 数据特征 | 推荐方法 |
|--------|--------|
| 精确数据，低维 | 多项式插值（Lagrange/Newton） |
| 噪声数据，趋势建模 | 最小二乘拟合（低次多项式） |
| 需要光滑插值 | 三次样条（`spline` 或 `csape`） |
| 模型已知（如指数） | 线性化 + 最小二乘 或 非线性拟合 |
